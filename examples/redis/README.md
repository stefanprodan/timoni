# Redis

[Redis](https://redis.io/) is an open source, in-memory data store used by
millions of developers as a database, cache, streaming engine, and message broker.

This module is for deploying a Redis master-replica cluster as a LRU cache
with persistent storage and
[append-only](https://redis.io/docs/management/persistence/#append-only-file)
durable strategy.

This module uses the Chainguard
[Redis container image](https://edu.chainguard.dev/chainguard/chainguard-images/reference/redis/overview/)
which comes with ARM and x86-64 support and fewer CVEs than the DockerHub Redis images.

## Module Repository

This module is available on GitHub Container Registry at
[ghcr.io/stefanprodan/modules/redis](https://github.com/stefanprodan/timoni/pkgs/container/modules%2Fredis).

## Install

To create an instance using the default values:

```shell
timoni -n default apply redis oci://ghcr.io/stefanprodan/modules/redis
```

The Redis cluster can be accessed using the following Kubernetes Services:

- `tcp://redis:6379` read-write endpoint for the Redis master
- `tcp://redis-readonly:6379` read-only endpoint with load balancing across Redis replicas

To install a specific module version:

```shell
timoni -n default apply redis oci://ghcr.io/stefanprodan/modules/redis -v 7.2.1
```

To change the [default configuration](#configuration),
create one or more `values.cue` files and apply them to the instance.

For example, create a file `my-values.cue` with the following content:

```cue
values: {
	maxmemory: 1024
	readonly: replicas: 2
	persistence: {
		enabled:      true
		storageClass: "standard"
		size:         "8Gi"
	}
}
```

And apply the values with:

```shell
timoni -n default apply redis oci://ghcr.io/stefanprodan/modules/redis \
--values ./my-values.cue
```

## Upgrade

To upgrade, run the [apply](#install) command for a different version and/or different values.

```shell
timoni -n default apply redis oci://ghcr.io/stefanprodan/modules/redis \
--version latest \
--values ./my-values.cue \
--values ./my-other-values.cue
```

On config changes, Timoni will first upgrade the Redis master,
will wait for it to become ready, then it will upgrade the read-only replicas.

## Uninstall

To uninstall an instance and delete all its Kubernetes resources:

```shell
timoni -n default delete redis
```

## Configuration

### Redis values

| Key                          | Type     | Default    | Description                                                                                                     |
|------------------------------|----------|------------|-----------------------------------------------------------------------------------------------------------------|
| `maxmemory:`                 | `int`    | `512`      | Redis max memory in Mi (this is also used to set `resources.limits.memory`)                                     |
| `readonly: replicas:`        | `int`    | `1`        | Number of Redis read-only replicas                                                                              |
| `persistence: enabled:`      | `bool`   | `true`     | Enable persistent storage for the Redis master node                                                             |
| `persistence: storageClass:` | `string` | `standard` | The [PersistentVolumeClaim](https://kubernetes.io/docs/concepts/storage/persistent-volumes/) storage class name |
| `persistence: size:`         | `string` | `8Gi`      | The persistent volume size                                                                                      |
| `password:`                  | `string` | `""`       | When set, it enables auth for both the master and replicas with the specified password                          |

### General values

| KEY                                                                                          | TYPE                                                                                                                                                                        | DESCRIPTION                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      |
|----------------------------------------------------------------------------------------------|-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------|----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| `kubeVersion:`                                                                               | `"1.27.5"`                                                                                                                                                                  | The kubeVersion is a required field, set at apply-time via timoni.cue by querying the user's Kubernetes API.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     |
| `clusterVersion: major:`                                                                     | `1`                                                                                                                                                                         |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |
| `clusterVersion: minor:`                                                                     | `27`                                                                                                                                                                        |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |
| `moduleVersion:`                                                                             | `"0.0.0-devel"`                                                                                                                                                             | The moduleVersion is set from the user-supplied module version. This field is used for the `app.kubernetes.io/version` label.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    |
| `metadata: name:`                                                                            | `"module-name"`                                                                                                                                                             | Name must be unique within a namespace. Is required when creating resources. Name is primarily intended for creation idempotence and configuration definition. More info: https://kubernetes.io/docs/concepts/overview/working-with-objects/names#names                                                                                                                                                                                                                                                                                                                                                                          |
| `metadata: namespace:`                                                                       | `"default"`                                                                                                                                                                 | Namespace defines the space within which each name must be unique. More info: https://kubernetes.io/docs/concepts/overview/working-with-objects/namespaces                                                                                                                                                                                                                                                                                                                                                                                                                                                                       |
| `metadata: annotations:`                                                                     | `{}`                                                                                                                                                                        | Annotations is an unstructured key value map stored with a resource that may be set to store and retrieve arbitrary metadata. More info: https://kubernetes.io/docs/concepts/overview/working-with-objects/annotations The annotations allows adding `metadata.annotations` to all resources.                                                                                                                                                                                                                                                                                                                                    |
| `metadata: labels: "app.kubernetes.io/name":`                                                | `"module-name"`                                                                                                                                                             |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |
| `metadata: labels: "app.kubernetes.io/version":`                                             | `"0.0.0-devel"`                                                                                                                                                             |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |
| `metadata: labels: "app.kubernetes.io/managed-by":`                                          | `"timoni"`                                                                                                                                                                  |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |
| `metadata: finalizers:`                                                                      | `[...string]`                                                                                                                                                               | Finalizers are namespaced keys that tell Kubernetes to wait until specific conditions are met before it fully deletes resources marked for deletion. More info: https://kubernetes.io/docs/concepts/overview/working-with-objects/finalizers/                                                                                                                                                                                                                                                                                                                                                                                    |
| `maxmemory:`                                                                                 | `*512 \| int & >=64`                                                                                                                                                        | Redis config                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     |
| `readonly: replicas:`                                                                        | `*1 \| int & >=0`                                                                                                                                                           |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |
| `persistence: enabled:`                                                                      | `*true \| bool`                                                                                                                                                             |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |
| `persistence: storageClass:`                                                                 | `*"standard" \| string`                                                                                                                                                     |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |
| `persistence: size:`                                                                         | `*"8Gi" \| string`                                                                                                                                                          |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |
| `password:`                                                                                  | `=~"^(([A-Za-z0-9][-A-Za-z0-9_.]*)?[A-Za-z0-9])?$"`                                                                                                                         |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |
| `image: repository:`                                                                         | `"cgr.dev/chainguard/redis"`                                                                                                                                                | Repository is the address of a container registry repository. An image repository is made up of slash-separated name components, optionally prefixed by a registry hostname and port in the format [HOST[:PORT_NUMBER]/]PATH.                                                                                                                                                                                                                                                                                                                                                                                                    |
| `image: tag:`                                                                                | `"7.2.4"`                                                                                                                                                                   | Tag identifies an image in the repository. A tag name may contain lowercase and uppercase characters, digits, underscores, periods and dashes. A tag name may not start with a period or a dash and may contain a maximum of 128 characters.                                                                                                                                                                                                                                                                                                                                                                                     |
| `image: digest:`                                                                             | `"sha256:6cf3066237a604fcf3e716aa9423cdd15383db49049bb594a337a97ca862ca50"`                                                                                                 | Digest uniquely and immutably identifies an image in the repository. Spec: https://github.com/opencontainers/image-spec/blob/main/descriptor.md#digests.                                                                                                                                                                                                                                                                                                                                                                                                                                                                         |
| `image: pullPolicy:`                                                                         | `*"IfNotPresent" \| "Always" \| "Never"`                                                                                                                                    | PullPolicy defines the pull policy for the image. By default, it is set to IfNotPresent.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         |
| `image: reference:`                                                                          | `"cgr.dev/chainguard/redis:7.2.4@sha256:6cf3066237a604fcf3e716aa9423cdd15383db49049bb594a337a97ca862ca50"`                                                                  | Reference is the image address computed from repository, tag and digest in the format [REPOSITORY]:[TAG]@[DIGEST].                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               |
| `imagePullSecrets:`                                                                          | `[...corev1.LocalObjectReference]`                                                                                                                                          |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |
| `resources: limits: cpu:`                                                                    | `=~"^[1-9]\\d*m$"`                                                                                                                                                          |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |
| `resources: limits: memory:`                                                                 | `*"544Mi" \| =~"^[1-9]\\d*(Mi\|Gi)$"`                                                                                                                                       |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |
| `resources: requests: cpu:`                                                                  | `*"100m" \| =~"^[1-9]\\d*m$"`                                                                                                                                               |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |
| `resources: requests: memory:`                                                               | `*"64Mi" \| =~"^[1-9]\\d*(Mi\|Gi)$"`                                                                                                                                        |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |
| `resources: claims:`                                                                         | `[...#ResourceClaim]`                                                                                                                                                       | Claims lists the names of resources, defined in spec.resourceClaims, that are used by this container.  This is an alpha field and requires enabling the DynamicResourceAllocation feature gate.  This field is immutable.  +listType=map +listMapKey=name +featureGate=DynamicResourceAllocation                                                                                                                                                                                                                                                                                                                                 |
| `podSecurityContext:`                                                                        | `*{	fsGroup:    1001	runAsUser:  1001	runAsGroup: 1001} \| {}`                                                                                                                 | Security (common to all deployments)                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             |
| `securityContext:`                                                                           | `*{	allowPrivilegeEscalation: false	readOnlyRootFilesystem:   true	runAsNonRoot:             true	capabilities: {		drop: ["ALL"]	}	seccompProfile: {		type: "RuntimeDefault"	}} \| {}` |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |
| `affinity: nodeAffinity: requiredDuringSchedulingIgnoredDuringExecution: nodeSelectorTerms:` | `[{	matchExpressions: [{		key:      "kubernetes.io/os"		operator: "In"		values: ["linux"]	}]}]`                                                                                     | Required. A list of node selector terms. The terms are ORed.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     |
| `affinity: nodeAffinity: preferredDuringSchedulingIgnoredDuringExecution:`                   | `[...{	weight: int32	preference: {}}]`                                                                                                                                        | The scheduler will prefer to schedule pods to nodes that satisfy the affinity expressions specified by this field, but it may choose a node that violates one or more of the expressions. The node that is most preferred is the one with the greatest sum of weights, i.e. for each node that meets all of the scheduling requirements (resource request, requiredDuringScheduling affinity expressions, etc.), compute a sum by iterating through the elements of this field and adding "weight" to the sum if the node matches the corresponding matchExpressions; the node(s) with the highest sum are the most preferred.   |
| `affinity: podAffinity:`                                                                     | `null \| {}`                                                                                                                                                                | Describes pod affinity scheduling rules (e.g. co-locate this pod in the same node, zone, etc. as some other pod(s)).                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             |
| `affinity: podAntiAffinity:`                                                                 | `null \| {}`                                                                                                                                                                | Describes pod anti-affinity scheduling rules (e.g. avoid putting this pod in the same node, zone, etc. as some other pod(s)).                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    |
| `podAnnotations:`                                                                            | `{}`                                                                                                                                                                        | Pod optional settings (common to all deployments)                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                |
| `tolerations:`                                                                               | `[...{}]`                                                                                                                                                                   |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |
| `topologySpreadConstraints:`                                                                 | `[...{	maxSkew:           int32	topologyKey:       string	whenUnsatisfiable: string}]`                                                                                         |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |
| `service: port:`                                                                             | `*6379 \| uint16 & >0`                                                                                                                                                      | Service                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          |
| `clusterDomain:`                                                                             | `"cluster.local"`                                                                                                                                                           |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |
| `test: enabled:`                                                                             | `*false \| bool`                                                                                                                                                            |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |

